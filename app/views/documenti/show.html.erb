<div class="mx-auto md:w-10/12 w-full flex gap-8">

  <%= tag.div class: "flex flex-col w-full" do%>
    <%= render Heading::WithActionsComponent.new(level: 'h2') do |heading| %>

        <%# <% heading.with_leader do %>
            <%# <%= render AvatarComponent.new(user: OpenStruct.new(name: "Ordine Cliente"), size: "xl") %>
        <%# <% end %>

        <% heading.with_description(css: "bg-red-500") {"nr #{@documento.numero_documento || 'BOZZA'} del #{@documento.data_documento&.strftime('%d-%m-%y')}" } %>

        <% heading.with_action do %>
            <%= button_to documento_path(@documento),
                    method: :delete,
                    form: { data: { turbo_prefetch: false, turbo: false } },
                    onclick: "return confirm('Sei sicuro di voler eliminare questo documento?')",
                    class: "flex sm:flex-col items-center gap-x-2
                  text-sm text-center font-semibold cursor-pointer
                  transition duration-150 ease-in-ou
                  rounded-md shadow-md  py-2 px-3
                      focus:outline focus:outline-2 focus:outline-offset-2
                  bg-red-600 text-white hover:bg-red-500
                  active:bg-red-600 focus:outline-red-600" do %>
            <%= icon "trash" %>
            Elimina
          <% end %>
        <% end %>

        <% heading.with_action do %>
            <%= component 'tax_button',
                    caption: "Stampa",
                    svg_file: "icon-print.svg",
                    color: "white",
                    url: documento_path(@documento, format: :pdf),
                    target: "_blank" %>
        <% end %>

        <% heading.with_action do %>
            <%= component 'tax_button',
                    caption: "Modifica",
                    svg_file: "icon-pencil.svg",
                    color: "yellow",
                    url:  documento_step_path(@documento, Documento.form_steps.keys.first) %>


        <% end %>

        <% heading.with_action do %>
            <%= component 'tax_button',
                    caption: "Indietro",
                    svg_file: "icon-arrow-long-left.svg",
                    color: "white",
                    url: awesome_back_path(except: /\/steps|\/edit/, fallback: documenti_path) %>
        <% end %>

        <% heading.with_action do %>
            <%= component 'tax_button',
                    caption: "Nuovo",
                    svg_file: "icon-plus.svg",
                    color: "blue",
                    url: url_for( controller: "documenti", action: "new", model: @documento ),
                    data_attr: { turbo_prefetch: false } %>
        <% end %>

        <%= @documento.causale || "Documento Bozza" %>

    <% end %>

    <div class="sm:flex sm:items-center">

        <div class="px-4 sm:flex-auto">
            <h1 class="text-xl font-semibold leading-6 text-gray-900">
                <%= render partial: "clientables/#{@documento.clientable.class.name.underscore}_card", locals: { clientable: @documento.clientable } %>
            </h1>

            <div class="mt-1 text-sm text-gray-700">
                <%= @documento.referente %>
            </div>
            <div class="mt-1 text-sm text-gray-500">
                <%= simple_format @documento.note %>
            </div>

            <%= tag.div class: "py-2 flex flex-row gap-2 sm:gap-4" do %>
                <%= render "shared/inline_edit", model: @documento, method: :stato_e_pagamento do %>
                    <%= tag.div @documento.status&.titleize, class: "text-sm text-gray-500 font-semibold" %>
                    <%= tag.div l(@documento.consegnato_il, format: "%d-%m"), class: "text-sm text-gray-500 font-semibold" if @documento.consegnato_il %>
                    <%= tag.div @documento.tipo_pagamento&.titleize, class: "text-sm text-gray-500 font-semibold" %>
                    <%= tag.div l(@documento.pagato_il, format: "%d-%m"), class: "text-sm text-gray-500 font-semibold" if @documento.pagato_il %>
                <% end %>

            <% end %>

            <% if @documento.documento_righe.size > 15 %>
                <%= tag.div id: "top", class: "w-full flex justify-end -pr-4" do %>
                    <%= component "tax_button",
                            svg_file: "icon-chevron-double-down",
                            color: "transparent",
                            url: "#bottom",
                            data_attr: { controller: "scroll-to",  scroll_to_offset_value: "300", scroll_to_behavior_value: "smooth" } %>
                <% end  %>
            <% end %>

        </div>

    </div>

    <div class="px-0 sm:px-4 mt-8 flow-root">
      <table class="min-w-full">
        <colgroup>
          <col class="w-full sm:w-1/2">
          <col class="sm:w-1/8">
          <col class="sm:w-1/8">
          <col class="sm:w-1/8">
          <col class="sm:w-1/6">
        </colgroup>

        <thead class="border-b border-gray-300 text-gray-900">
          <tr>
            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">Titolo</th>
            <th scope="col" class="hidden px-3 py-3.5 text-right text-sm font-semibold text-gray-900 sm:table-cell">Prezzo</th>
            <th scope="col" class="px-3 py-3.5 text-right text-sm font-semibold text-gray-900">Quantita</th>
            <th scope="col" class="hidden px-3 py-3.5 text-right text-sm font-semibold text-gray-900 sm:table-cell">Sconto</th>
            <th scope="col" class="py-3.5 pl-3 pr-4 text-right text-sm font-semibold text-gray-900 sm:pr-0">Importo</th>
          </tr>
        </thead>

        <tbody>

          <%
            # Helper per raccogliere tutte le righe dei documenti derivati
            def collect_all_descendant_righe_recursive(doc, collected = {})
              doc.documenti_derivati.each do |figlio|
                figlio.righe.each { |riga| collected[riga.id] = riga }
                collect_all_descendant_righe_recursive(figlio, collected)
              end
              collected
            end

            # Righe del documento che NON sono nei derivati
            tutte_righe_derivati = collect_all_descendant_righe_recursive(@documento)
            righe_solo_documento = @documento.righe.reject { |riga| tutte_righe_derivati.key?(riga.id) }
          %>

          <!-- Righe esclusive del documento (non condivise con derivati) -->
          <% if righe_solo_documento.any? %>
            <tr class="border-t border-gray-300 bg-gray-100">
              <td colspan="5" class="py-2 pl-4 pr-3 text-sm font-bold text-gray-700 sm:pl-0">
                <div class="flex items-center gap-2 pl-2">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                  </svg>
                  
                </div>
              </td>
            </tr>
            <% righe_solo_documento.each do |riga| %>
              <%= render partial: "righe/riga", locals: { riga: riga } %>
            <% end %>
          <% end %>

          <!-- Righe raggruppate per documento derivato -->
          <% @documento.documenti_derivati.order(:data_documento).each do |doc_derivato| %>
            <%
              # Righe del documento che appartengono a questo derivato
              righe_derivato_ids = doc_derivato.righe.pluck(:id)
              righe_per_derivato = @documento.righe.select { |riga| righe_derivato_ids.include?(riga.id) }
            %>

            <!-- Documenti nipoti (livello 2) -->
            <% if doc_derivato.documenti_derivati.any? %>
              <!-- Header documento derivato di livello 1 (es. DDT) -->
              <tr class="border-t-2 border-blue-300 bg-blue-100">
                <td colspan="5" class="py-2 pl-4 pr-3 text-sm font-bold text-blue-900 sm:pl-0">
                  <div class="flex items-center gap-2 pl-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                    </svg>
                    <%= doc_derivato.causale&.causale %> #<%= doc_derivato.numero_documento %> del <%= doc_derivato.data_documento&.strftime("%d-%m-%Y") %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-200 text-purple-900">
                      <%= doc_derivato.documenti_derivati.count %> sotto-documenti
                    </span>
                    <%= link_to "Vedi", documento_path(doc_derivato), class: "text-xs text-blue-700 hover:text-blue-900 underline", data: { turbo_frame: :_top } %>
                  </div>
                </td>
              </tr>

              <!-- Documenti nipoti con le loro righe -->
              <% doc_derivato.documenti_derivati.order(:data_documento).each do |doc_nipote| %>
                <%
                  # Righe del documento che appartengono a questo nipote
                  righe_nipote_ids = doc_nipote.righe.pluck(:id)
                  righe_per_nipote = @documento.righe.select { |riga| righe_nipote_ids.include?(riga.id) }
                %>

                <% if righe_per_nipote.any? %>
                  <!-- Header documento nipote (es. Ordine) -->
                  <tr class="border-t border-purple-300 bg-purple-50">
                    <td colspan="5" class="py-2 pl-8 pr-3 text-sm font-semibold text-purple-900 sm:pl-6">
                      <div class="flex items-center gap-2 pl-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                        </svg>
                        <%= doc_nipote.causale&.causale %> #<%= doc_nipote.numero_documento %> del <%= doc_nipote.data_documento&.strftime("%d-%m-%Y") %>
                        <% if doc_nipote.status.present? %>
                          <span class="text-xs text-purple-700">[<%= doc_nipote.status.titleize %>]</span>
                        <% end %>
                        <%= link_to "Vedi", documento_path(doc_nipote), class: "text-xs text-purple-700 hover:text-purple-900 underline", data: { turbo_frame: :_top } %>
                      </div>
                    </td>
                  </tr>

                  <!-- Righe del nipote -->
                  <% righe_per_nipote.each do |riga| %>
                    <%= render partial: "righe/riga", locals: { riga: riga } %>
                  <% end %>
                <% end %>
              <% end %>

            <% else %>
              <!-- Documento derivato senza nipoti - mostra direttamente le sue righe -->
              <% if righe_per_derivato.any? %>
                <!-- Header documento derivato -->
                <tr class="border-t-2 border-blue-300 bg-blue-100">
                  <td colspan="5" class="py-2 pl-4 pr-3 text-sm font-bold text-blue-900 sm:pl-0">
                    <div class="flex items-center gap-2 pl-2">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                      </svg>
                      <%= doc_derivato.causale&.causale %> #<%= doc_derivato.numero_documento %> del <%= doc_derivato.data_documento&.strftime("%d-%m-%Y") %>
                      <% if doc_derivato.status.present? %>
                        <span class="text-xs text-blue-700">[<%= doc_derivato.status.titleize %>]</span>
                      <% end %>
                      <%= link_to "Vedi", documento_path(doc_derivato), class: "text-xs text-blue-700 hover:text-blue-900 underline", data: { turbo_frame: :_top } %>
                    </div>
                  </td>
                </tr>

                <!-- Righe del derivato -->
                <% righe_per_derivato.each do |riga| %>
                  <%= render partial: "righe/riga", locals: { riga: riga } %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>

        </tbody>

        <tfoot>
          <tr>
            <th scope="row" colspan="4" class="hidden pl-4 pr-3 pt-4 text-right text-sm font-normal text-gray-500 sm:table-cell sm:pl-0">Totale copie</th>
            <th scope="row" colspan="2" class="pl-4 pr-3 pt-4 text-left text-sm font-normal text-gray-500 sm:hidden">Totale copie</th>
            <td class="pl-3 pr-4 pt-4 text-right text-sm text-gray-500 sm:pr-0">
              <%= @documento.righe.sum(&:quantita) %>
            </td>
          </tr>
          <tr>
            <th scope="row" colspan="4" class="hidden pl-4 pr-3 pt-4 text-right text-sm font-semibold text-gray-900 sm:table-cell sm:pl-0">Totale importo</th>
            <th scope="row" colspan="2" class="pl-4 pr-3 pt-4 text-left text-sm font-semibold text-gray-900 sm:hidden">Totale importo</th>
            <td class="pl-3 pr-4 pt-4 text-right text-sm font-semibold text-gray-900 sm:pr-0">
              <%= number_to_currency @documento.righe.sum(&:importo), locale: :it %>
            </td>
          </tr>
        </tfoot>
      </table>

      <% if @documento.documento_righe.size > 20 %>
          <%= tag.div id: "bottom", class: "w-full flex justify-end -pr-4" do %>
              <%= component "tax_button",
                      svg_file: "icon-chevron-double-up",
                      color: "transparent",
                      url: "#top",
                      data_attr: { controller: "scroll-to",  scroll_to_offset_value: "300", scroll_to_behavior_value: "smooth" } %>
          <% end  %>
      <% end %>

    </div>

    <%= link_to "Esporta XML", esporta_xml_documento_path(@documento, format: :xml),
                class: "btn btn-primary" %>

  <% end %>

</div>

